<div class="history-container">
  <!-- Header -->
  <header class="history-header">
    <a routerLink="/" class="back-button">â† Back</a>
    <h1>Task History</h1>
    <button class="btn-add-date" (click)="openDatePicker()">
      ğŸ“… Add Tasks to Date
    </button>
  </header>

  <!-- Main Content -->
  <main class="history-content">
    
    @if (dateTasks().length === 0) {
      <div class="empty-history">
        <p>ğŸ“­ No task history yet</p>
        <p class="empty-subtitle">Start adding tasks to build your history!</p>
        <button class="btn btn-primary" (click)="openDatePicker()">
          Add Tasks to a Date
        </button>
      </div>
    } @else {
      <!-- Date List -->
      <div class="dates-list">
        @for (dateTask of dateTasks(); track dateTask.date; let i = $index) {
          <div class="date-card" [class.expanded]="dateTask.expanded">
            <!-- Date Header (Clickable) -->
            <div class="date-header" (click)="toggleDate(i)">
              <div class="date-info">
                <h2>{{ dateTask.displayDate }}</h2>
                <div class="date-summary">
                  <span class="summary-item signal-summary">
                    ğŸ¯ {{ dateTask.signalTasks.length }} Signal
                    ({{ getCompletedCount(dateTask.signalTasks) }} done)
                  </span>
                  <span class="summary-item noise-summary">
                    ğŸ“ {{ dateTask.noiseTasks.length }} Noise
                    ({{ getCompletedCount(dateTask.noiseTasks) }} done)
                  </span>
                </div>
              </div>
              <div class="expand-icon">
                {{ dateTask.expanded ? 'â–¼' : 'â–¶' }}
              </div>
            </div>

            <!-- Expanded Content -->
            @if (dateTask.expanded) {
              <div class="date-content">
                
                <!-- Metrics Summary for this date -->
                @if (dateTask.metrics && dateTask.metrics.total > 0) {
                  <div class="date-metrics-summary">
                    <h4>ğŸ“Š Productivity Summary</h4>
                    <p class="metrics-summary-message">{{ dateTask.metrics.summaryMessage }}</p>
                    
                    <div class="metrics-compact">
                      <div class="compact-metric">
                        <span class="metric-label">Planned:</span>
                        <span class="metric-ratio signal-text">{{ dateTask.metrics.plannedSignalPercent.toFixed(0) }}%</span>
                        <span class="metric-separator">:</span>
                        <span class="metric-ratio noise-text">{{ dateTask.metrics.plannedNoisePercent.toFixed(0) }}%</span>
                      </div>
                      <div class="compact-metric">
                        <span class="metric-label">Executed:</span>
                        <span class="metric-ratio signal-text">{{ ((dateTask.metrics.signalDone + dateTask.metrics.noiseDone) > 0 ? (dateTask.metrics.signalDone / (dateTask.metrics.signalDone + dateTask.metrics.noiseDone) * 100) : 0).toFixed(0) }}%</span>
                        <span class="metric-separator">:</span>
                        <span class="metric-ratio noise-text">{{ ((dateTask.metrics.signalDone + dateTask.metrics.noiseDone) > 0 ? (dateTask.metrics.noiseDone / (dateTask.metrics.signalDone + dateTask.metrics.noiseDone) * 100) : 0).toFixed(0) }}%</span>
                      </div>
                      <div class="compact-metric">
                        <span class="metric-label">Completion:</span>
                        <span class="metric-detail">ğŸ¯ {{ dateTask.metrics.completionSignalPercent.toFixed(0) }}%</span>
                        <span class="metric-detail">ğŸ“ {{ dateTask.metrics.completionNoisePercent.toFixed(0) }}%</span>
                      </div>
                    </div>
                  </div>
                }
                
                <!-- Signal Tasks -->
                <div class="task-section signal-section">
                  <h3>
                    <span class="icon">ğŸ¯</span> Signal Tasks
                  </h3>
                  
                  @if (dateTask.signalTasks.length === 0) {
                    <p class="empty-state">No Signal tasks for this day</p>
                  } @else {
                    <div class="tasks-list">
                      @for (task of dateTask.signalTasks; track task.id) {
                        <div class="task-item" [class.task-done]="task.done">
                          <label class="task-checkbox">
                            <input
                              type="checkbox"
                              [checked]="task.done"
                              (change)="toggleTask(task.id, dateTask.date)"
                            />
                            <span class="checkmark"></span>
                          </label>
                          <span class="task-title">{{ task.title }}</span>
                          <button 
                            class="btn-delete"
                            (click)="deleteTask(task.id, dateTask.date)"
                            title="Delete task"
                          >
                            Ã—
                          </button>
                        </div>
                      }
                    </div>
                  }
                </div>

                <!-- Noise Tasks -->
                <div class="task-section noise-section">
                  <h3>
                    <span class="icon">ğŸ“</span> Noise Tasks
                  </h3>
                  
                  @if (dateTask.noiseTasks.length === 0) {
                    <p class="empty-state">No Noise tasks for this day</p>
                  } @else {
                    <div class="tasks-list">
                      @for (task of dateTask.noiseTasks; track task.id) {
                        <div class="task-item" [class.task-done]="task.done">
                          <label class="task-checkbox">
                            <input
                              type="checkbox"
                              [checked]="task.done"
                              (change)="toggleTask(task.id, dateTask.date)"
                            />
                            <span class="checkmark"></span>
                          </label>
                          <span class="task-title">{{ task.title }}</span>
                          <button 
                            class="btn-delete"
                            (click)="deleteTask(task.id, dateTask.date)"
                            title="Delete task"
                          >
                            Ã—
                          </button>
                        </div>
                      }
                    </div>
                  }
                </div>

                <!-- Delete Date Button -->
                <div class="date-actions">
                  <button class="btn btn-danger-outline" (click)="deleteDate(dateTask.date)">
                    ğŸ—‘ï¸ Delete This Day
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </main>

  <!-- Date Picker Modal -->
  @if (showDatePicker()) {
    <div class="modal-overlay" (click)="closeDatePicker()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ addingToDate() ? 'Add Tasks' : 'Select Date' }}</h2>
          <button class="btn-close" (click)="closeDatePicker()">Ã—</button>
        </div>

        <div class="modal-body">
          
          @if (!addingToDate()) {
            <!-- Date Selection -->
            <div class="date-selector">
              <label for="task-date">Select a date:</label>
              <input
                id="task-date"
                type="date"
                [(ngModel)]="selectedDate"
                class="date-input"
              />
              <button 
                class="btn btn-primary"
                (click)="selectDateForTasks()"
                [disabled]="!selectedDate"
              >
                Continue
              </button>
            </div>
          } @else {
            <!-- Task Input for Selected Date -->
            <div class="task-input-section">
              <p class="selected-date-display">
                Adding tasks for: <strong>{{ taskService.formatDate(addingToDate()!) }}</strong>
              </p>

              <!-- Signal Tasks -->
              <div class="input-group signal-input">
                <h3>ğŸ¯ Signal Tasks</h3>
                <div class="add-task-form">
                  <input
                    type="text"
                    [(ngModel)]="newSignalTask"
                    placeholder="Add a Signal task..."
                    class="task-input"
                    (keyup.enter)="addSignalTaskToDate()"
                  />
                  <button 
                    class="btn btn-primary"
                    (click)="addSignalTaskToDate()"
                    [disabled]="!newSignalTask.trim()"
                  >
                    Add
                  </button>
                </div>
              </div>

              <!-- Noise Tasks -->
              <div class="input-group noise-input">
                <h3>ğŸ“ Noise Tasks</h3>
                <div class="add-task-form">
                  <input
                    type="text"
                    [(ngModel)]="newNoiseTask"
                    placeholder="Add a Noise task..."
                    class="task-input"
                    (keyup.enter)="addNoiseTaskToDate()"
                  />
                  <button 
                    class="btn btn-primary"
                    (click)="addNoiseTaskToDate()"
                    [disabled]="!newNoiseTask.trim()"
                  >
                    Add
                  </button>
                </div>
              </div>

              <div class="modal-actions">
                <button class="btn btn-success" (click)="finishAddingTasks()">
                  âœ“ Done Adding Tasks
                </button>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
